<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visor de Historial de Eliminados (TXT/CSV)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .table-container {
        max-height: 60vh; /* Ajustado para dar más espacio a los filtros */
        overflow-y: auto;
      }
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          Visor de Historial de Eliminados
        </h1>
        <p class="text-gray-600">
          Sube y consulta tu archivo `historial_eliminados.txt` o `.csv` para
          buscar y filtrar los registros.
        </p>
      </div>

      <!-- Dropzone para subir archivo -->
      <div
        id="upload-container"
        class="bg-white rounded-2xl shadow-lg p-8 text-center border-4 border-dashed border-gray-200 hover:border-blue-500 transition-colors duration-300 cursor-pointer"
      >
        <input type="file" id="file-input" class="hidden" accept=".txt,.csv" />
        <svg
          class="mx-auto h-12 w-12 text-gray-400"
          stroke="currentColor"
          fill="none"
          viewBox="0 0 48 48"
          aria-hidden="true"
        >
          <path
            d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <h2 class="mt-4 text-xl font-semibold text-gray-900">
          Arrastra y suelta tu archivo o haz clic para seleccionar
        </h2>
        <p class="mt-1 text-sm text-gray-600">Soporta archivos .txt y .csv</p>
        <p id="file-name" class="mt-4 text-sm font-medium text-blue-600"></p>
      </div>

      <!-- Contenedor principal de la aplicación (inicialmente oculto) -->
      <div id="app-container" class="hidden">
        <!-- Filtros -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <!-- Filtro de Búsqueda por Columna -->
          <div class="bg-white rounded-2xl shadow-lg p-4">
            <label
              for="search-column"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Buscar en:</label
            >
            <select
              id="search-column"
              class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition mb-2"
            >
              <option value="content">Contenido</option>
              <option value="date">Fecha de Proceso</option>
              <option value="file">Archivo Procesado</option>
              <option value="line">Línea</option>
            </select>
            <input
              type="text"
              id="search-input"
              placeholder="Término de búsqueda..."
              class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
            />
          </div>
          <!-- Filtro por Archivo -->
          <div class="bg-white rounded-2xl shadow-lg p-4">
            <label
              for="file-filter"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Filtrar por archivo:</label
            >
            <select
              id="file-filter"
              class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
            >
              <option value="">Todos los archivos</option>
            </select>
          </div>
          <!-- Filtro por Rango de Fechas -->
          <div
            class="bg-white rounded-2xl shadow-lg p-4 lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4"
          >
            <div>
              <label
                for="date-start-filter"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Fecha Desde:</label
              >
              <input
                type="date"
                id="date-start-filter"
                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
              />
            </div>
            <div>
              <label
                for="date-end-filter"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Fecha Hasta:</label
              >
              <input
                type="date"
                id="date-end-filter"
                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
              />
            </div>
          </div>
        </div>

        <!-- Estadísticas -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            <div>
              <p class="text-2xl font-bold text-blue-600" id="total-records">
                0
              </p>
              <p class="text-sm text-gray-600">Registros Totales</p>
            </div>
            <div>
              <p
                class="text-2xl font-bold text-green-600"
                id="total-records-display"
              >
                0
              </p>
              <p class="text-sm text-gray-600">Mostrando Actualmente</p>
            </div>
            <div>
              <p class="text-2xl font-bold text-purple-600" id="total-files">
                0
              </p>
              <p class="text-sm text-gray-600">Archivos Procesados</p>
            </div>
            <div>
              <p
                class="text-2xl font-bold text-yellow-600"
                id="last-process-date"
              >
                -
              </p>
              <p class="text-sm text-gray-600">Último Proceso</p>
            </div>
          </div>
        </div>

        <!-- Tabla de resultados -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
          <div class="table-container">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0 z-10">
                <!-- Añadido z-10 -->
                <tr>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Fecha de Proceso
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Archivo Procesado
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Línea
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Contenido
                  </th>
                </tr>
              </thead>
              <tbody
                id="results-table"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- Los resultados se insertarán aquí -->
              </tbody>
            </table>
          </div>
          <div id="no-results" class="text-center p-8 text-gray-500 hidden">
            <p>No se encontraron resultados para tu búsqueda.</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Contenedores de la interfaz
      const uploadContainer = document.getElementById("upload-container");
      const fileInput = document.getElementById("file-input");
      const fileNameDisplay = document.getElementById("file-name");
      const appContainer = document.getElementById("app-container");

      // Elementos de la aplicación
      const searchInput = document.getElementById("search-input");
      const searchColumnSelect = document.getElementById("search-column");
      const fileFilter = document.getElementById("file-filter");
      const dateStartFilter = document.getElementById("date-start-filter"); // Nuevo input fecha inicio
      const dateEndFilter = document.getElementById("date-end-filter"); // Nuevo input fecha fin
      const resultsTable = document.getElementById("results-table");
      const noResults = document.getElementById("no-results");

      // Elementos de estadísticas
      const totalRecordsStat = document.getElementById("total-records");
      const totalRecordsDisplayStat = document.getElementById(
        "total-records-display"
      );
      const totalFilesStat = document.getElementById("total-files");
      const lastProcessDateStat = document.getElementById("last-process-date");

      let allData = [];

      // --- Manejo de la subida de archivos (con limpieza de nuevos filtros) ---
      uploadContainer.addEventListener("click", () => fileInput.click());
      uploadContainer.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadContainer.classList.add("border-blue-500", "bg-blue-50");
      });
      uploadContainer.addEventListener("dragleave", () => {
        uploadContainer.classList.remove("border-blue-500", "bg-blue-50");
      });
      uploadContainer.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadContainer.classList.remove("border-blue-500", "bg-blue-50");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });
      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleFile(e.target.files[0]);
        }
      });

      function handleFile(file) {
        fileNameDisplay.textContent = `Archivo cargado: ${file.name}`;
        const reader = new FileReader();
        reader.onload = (e) => {
          const content = e.target.result;
          const fileExtension = file.name.split(".").pop().toLowerCase();

          // Limpiar filtros antes de cargar nuevos datos
          searchInput.value = "";
          searchColumnSelect.value = "content";
          fileFilter.innerHTML = '<option value="">Todos los archivos</option>';
          dateStartFilter.value = ""; // Limpiar fecha inicio
          dateEndFilter.value = ""; // Limpiar fecha fin

          if (fileExtension === "csv") {
            allData = parseCsv(content);
          } else if (fileExtension === "txt") {
            allData = parseLog(content);
          } else {
            console.error("Tipo de archivo no soportado");
            fileNameDisplay.textContent = `Error: Tipo de archivo no soportado. Use .txt o .csv`;
            allData = [];
            appContainer.classList.add("hidden");
            uploadContainer.classList.remove("hidden");
            return;
          }

          if (allData.length === 0) {
            fileNameDisplay.textContent +=
              " - Archivo vacío o formato incorrecto.";
            appContainer.classList.add("hidden");
            uploadContainer.classList.remove("hidden");
          } else {
            initialize_app();
          }
        };
        reader.onerror = () => {
          console.error("Error al leer el archivo.");
          fileNameDisplay.textContent = "Error al leer el archivo.";
          allData = [];
          appContainer.classList.add("hidden");
          uploadContainer.classList.remove("hidden");
        };
        reader.readAsText(file);
      }

      // --- Funciones de Parseo (parseLog, parseCsv - sin cambios) ---
      function parseLog(text) {
        const records = [];
        const blocks = text
          .split("==================================================")
          .filter((b) => b.trim() !== "");

        blocks.forEach((block) => {
          const lines = block.trim().split("\n");
          let currentDate = null;
          let currentFile = null;

          const dateMatch = lines.find((line) =>
            line.startsWith("Fecha de proceso:")
          );
          if (dateMatch) {
            currentDate = dateMatch.replace("Fecha de proceso:", "").trim();
          }

          const fileMatch = lines.find((line) =>
            line.startsWith("Archivo procesado:")
          );
          if (fileMatch) {
            currentFile = fileMatch.replace("Archivo procesado:", "").trim();
          }

          const itemsHeaderIndex = lines.findIndex((line) =>
            line.includes("Línea  | Contenido")
          );
          if (itemsHeaderIndex !== -1 && currentDate && currentFile) {
            const items = lines.slice(itemsHeaderIndex + 2); // Omitir la línea de cabecera y el separador
            items.forEach((itemLine) => {
              const parts = itemLine.split("|");
              if (parts.length === 2) {
                const lineNumber = parts[0].trim();
                const content = parts[1].trim();
                // Intentar parsear la fecha para validarla un poco
                const dateTimeString = currentDate.replace(" ", "T");
                const dateObj = new Date(dateTimeString);

                if (
                  lineNumber &&
                  content &&
                  content !== "[Línea en blanco]" &&
                  !isNaN(dateObj.getTime())
                ) {
                  records.push({
                    date: currentDate,
                    file: currentFile,
                    line: lineNumber,
                    content: content,
                  });
                } else if (
                  lineNumber &&
                  content &&
                  content !== "[Línea en blanco]"
                ) {
                  console.warn(
                    `Fecha inválida encontrada en bloque TXT: ${currentDate}. Registro ignorado: ${itemLine}`
                  );
                }
              }
            });
          } else if (!currentDate || !currentFile) {
            console.warn(
              `Bloque TXT sin fecha o archivo procesado: ${block.substring(
                0,
                100
              )}...`
            );
          }
        });
        return records;
      }

      function parseCsv(text) {
        const records = [];
        const lines = text.trim().split("\n");

        if (lines.length <= 1) return records; // Vacío o solo cabecera

        // Omitir la cabecera (línea 0)
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const parts = line.split(",");

          if (parts.length >= 4) {
            const date = parts[0].replace(/"/g, "").trim();
            const file = parts[1].replace(/"/g, "").trim();
            const lineNum = parts[2].replace(/"/g, "").trim();
            const content = parts.slice(3).join(",").replace(/"/g, "").trim();

            // Validar fecha un poco
            const dateTimeString = date.replace(" ", "T");
            const dateObj = new Date(dateTimeString);

            if (
              date &&
              file &&
              lineNum &&
              content &&
              !isNaN(dateObj.getTime())
            ) {
              records.push({
                date: date,
                file: file,
                line: lineNum,
                content: content,
              });
            } else {
              console.warn(
                `Línea CSV ignorada por formato o fecha inválida: ${line}`
              );
            }
          } else {
            console.warn(
              `Línea CSV ignorada por número incorrecto de partes: ${line}`
            );
          }
        }
        return records;
      }

      // --- Inicialización y UI (con listeners para nuevos filtros) ---
      function initialize_app() {
        uploadContainer.classList.add("hidden");
        appContainer.classList.remove("hidden");

        populateFileFilter();
        updateStats();
        renderTable(allData);

        // Añadir event listeners para los filtros
        searchInput.addEventListener("input", applyFilters);
        searchColumnSelect.addEventListener("change", applyFilters);
        fileFilter.addEventListener("change", applyFilters);
        dateStartFilter.addEventListener("change", applyFilters); // Listener para fecha inicio
        dateEndFilter.addEventListener("change", applyFilters); // Listener para fecha fin
      }

      // --- populateFileFilter y updateStats (sin cambios) ---
      function populateFileFilter() {
        fileFilter.innerHTML = '<option value="">Todos los archivos</option>';
        const files = [...new Set(allData.map((item) => item.file))];
        files.sort();
        files.forEach((file) => {
          const option = document.createElement("option");
          option.value = file;
          option.textContent = file;
          fileFilter.appendChild(option);
        });
      }

      function updateStats(filteredData) {
        totalRecordsStat.textContent = allData.length.toLocaleString();
        totalRecordsDisplayStat.textContent = (
          filteredData ? filteredData.length : allData.length
        ).toLocaleString();

        const uniqueFiles = [...new Set(allData.map((item) => item.file))];
        totalFilesStat.textContent = uniqueFiles.length;

        if (allData.length > 0) {
          const sortedDates = allData
            .map((d) => {
              const dateTimeString = d.date.replace(" ", "T");
              const dateObj = new Date(dateTimeString);
              return isNaN(dateObj.getTime()) ? null : dateObj;
            })
            .filter((d) => d !== null)
            .sort((a, b) => b - a);

          if (sortedDates.length > 0) {
            lastProcessDateStat.textContent = sortedDates[0].toLocaleDateString(
              "es-CO",
              { year: "numeric", month: "2-digit", day: "2-digit" }
            );
          } else {
            lastProcessDateStat.textContent = "-";
          }
        } else {
          lastProcessDateStat.textContent = "-";
        }
      }

      // --- Aplicar Filtros (MODIFICADO para rango de fechas) ---
      function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const searchColumn = searchColumnSelect.value;
        const selectedFile = fileFilter.value;
        const startDate = dateStartFilter.value; // Obtener fecha inicio
        const endDate = dateEndFilter.value; // Obtener fecha fin

        let filteredData = allData;

        // Filtrar por término de búsqueda
        if (searchTerm && searchColumn) {
          filteredData = filteredData.filter((item) => {
            const columnValue =
              item[searchColumn]?.toString().toLowerCase() || "";
            return columnValue.includes(searchTerm);
          });
        }

        // Filtrar por archivo
        if (selectedFile) {
          filteredData = filteredData.filter(
            (item) => item.file === selectedFile
          );
        }

        // Filtrar por rango de fechas
        if (startDate || endDate) {
          filteredData = filteredData.filter((item) => {
            // Extraer solo la parte de la fecha (YYYY-MM-DD) del registro
            const itemDatePart = item.date.split(" ")[0];
            if (!itemDatePart) return false; // Ignorar si no hay fecha

            let isAfterStart = true;
            let isBeforeEnd = true;

            if (startDate) {
              isAfterStart = itemDatePart >= startDate;
            }
            if (endDate) {
              isBeforeEnd = itemDatePart <= endDate;
            }

            return isAfterStart && isBeforeEnd;
          });
        }

        renderTable(filteredData);
        updateStats(filteredData);
      }

      // --- Renderizar Tabla (sin cambios) ---
      function renderTable(data) {
        resultsTable.innerHTML = "";
        if (data.length === 0) {
          noResults.classList.remove("hidden");
        } else {
          noResults.classList.add("hidden");
          data.forEach((item) => {
            const row = document.createElement("tr");
            row.className = "hover:bg-gray-50 transition-colors duration-150";
            row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${
                          item.date || "-"
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${
                          item.file || "-"
                        }</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">${
                          item.line || "-"
                        }</td>
                        <td class="px-6 py-4 whitespace-normal text-sm text-gray-900">${
                          item.content || "-"
                        }</td>
                    `;
            resultsTable.appendChild(row);
          });
        }
      }
    </script>
  </body>
</html>
